service: MagicMirror

plugins:
  - serverless-python-requirements
  - serverless-wsgi
  - serverless-stack-output
  - serverless-export-env

package:
  exclude:
    - node_modules/**
    - package.json
    - package-lock.json
    - stack.json
    - tests/**
    - requirements.txt
    - run.py

custom:
  variables:
    dynamodb:
      usersTableName:
       ${{self:service}}-${{self:provider.stage}}-users
      deviceGroupTableName:
       ${{self:service}}-${{self:provider.stage}}-device-group
      deviceGroupUsersTableName:
       ${{self:service}}-${{self:provider.stage}}-device-group-users
      deviceGroupUserFacesTableName:
       ${{self:service}}-${{self:provider.stage}}-device-group-user-faces
  wsgi:
    app: app.app.app
    packRequirements: false
  pythonRequirements:
    dockerizePip: 'non-linux'
  output:
    # handler: out.handler  # function handler (data, serverless, options) {console.log('Received Stack Output', data)}} module.exports = { handler }}
    file: stack.json

provider:
  name: aws
  runtime: python3.6
  stage: dev
  region: eu-west-1
  variableSyntax: "\\${{([ ~:a-zA-Z0-9._\\'\",\\-\\/\\(\\)]+?)}}"
  environment:
    USER_POOL_ID:
      Ref: UserPool
    USERS_TABLE:
      ${{self:custom.variables.dynamodb.usersTableName}}
    DEVICE_GROUP_TABLE:
      ${{self:custom.variables.dynamodb.deviceGroupTableName}}
    DEVICE_GROUP_USERS_TABLE:
      ${{self:custom.variables.dynamodb.deviceGroupUsersTableName}}
    DEVICE_GROUP_USER_FACES_TABLE:
      ${{self:custom.variables.dynamodb.deviceGroupUserFacesTableName}}
  iamRoleStatements:
    - Effect: "Allow"
      Action:
       - dynamodb:Query
       - dynamodb:Scan
       - dynamodb:GetItem
       - dynamodb:BatchGetItem
       - dynamodb:PutItem
       - dynamodb:UpdateItem
       - dynamodb:DeleteItem
      Resource:
        - Fn::GetAtt:
          - DeviceGroupTable
          - Arn
        - Fn::GetAtt:
          - DeviceGroupUsersTable
          - Arn
        - Fn::Join:
          - ""
          - - Fn::GetAtt:
              - DeviceGroupUsersTable
              - Arn
            - "/index/*"
        - Fn::GetAtt:
          - DeviceGroupUserFacesTable
          - Arn


  # Fn::Join:
  #   - ""
  #   - - "arn:aws:dynamodb:"
  #     - Ref: AWS::Region
  #     - ":"
  #     - Ref: AWS::AccountId
  #     - ":table/"
  #     - Ref: UsersTable

# DeviceGroupUsersTable
# Properties
# GlobalSecondaryIndexes
# IndexName
# useridGSI

functions:
  app:
    handler: wsgi.handler
    events:
      # - http: ANY /
      # - http: 'ANY {proxy+}'
      - http:
          path: '{proxy+}'
          method: ANY
          cors:
            origins: '*'
            headers:
              - Content-Type
              - Access-Control-Allow-Origin
              - Access-Control-Allow-Methods
              - Access-Control-Allow-Headers
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
              - X-Amz-Date
            allowCredentials: false
          authorizer:
            identitySource: "method.request.header.Authorization"
            arn: arn:aws:cognito-idp:eu-west-1:834819762693:userpool/eu-west-1_PtJ4NoVML  # TODO when fix available!!! or multi stack :(
              # https://github.com/serverless/serverless/issues/2240#issuecomment-268411199
              # https://forum.serverless.com/t/cognito-user-identity-pools-as-serverless-yml-resource-defs/2050/9
              # https://github.com/serverless/serverless/issues/3212#issuecomment-307341924
              # https://github.com/serverless/serverless/issues/3212#issuecomment-307341924
            # providerArn:
              # Fn::GetAtt:
              #   - UserPool
              #   - Arn
            type: "COGNITO_USER_POOLS"
      - http:
          path: '/'
          method: ANY
          cors:
            origins: '*'
            headers:
              - Content-Type
              - Access-Control-Allow-Origin
              - Access-Control-Allow-Methods
              - Access-Control-Allow-Headers
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
              - X-Amz-Date
            allowCredentials: false
          authorizer:
            identitySource: "method.request.header.Authorization"
            arn: arn:aws:cognito-idp:eu-west-1:834819762693:userpool/eu-west-1_PtJ4NoVML
            type: "COGNITO_USER_POOLS"

resources:
  Resources:

    # LoggingPermissionPolicy:
    #   Type: AWS::IAM::Policy
    #   Properties:
    #     PolicyName: LoggingPermission
    #     PolicyDocument:
    #       Version: 2012-10-17
    #       Statement:
    #         - Effect: Allow
    #           Action:
    #             - logs:CreateLogGroup
    #             - logs:CreateLogStream
    #             - logs:PutLogEvents
    #           Resource: arn:aws:logs:${self:provider.region}:${accountId}:log-group:/aws/lambda/*:*:*
    #     Roles:
    #       - Ref: MyRole


    # # Create a IAM role for accessing SES to send confirmation emails
    # SESRole:
    #   Type: "AWS::IAM::Role"
    #   Properties:
    #     AssumeRolePolicyDocument:
    #       Version: "2008-10-17"
    #       Statement:
    #         - Effect: "Allow"
    #           Principal:
    #             Service:
    #               - "cognito-idp.amazonaws.com"
    #           Action:
    #             - "sts:AssumeRole"
    #     Policies:
    #       - PolicyName: "CognitoSESPolicy"
    #         PolicyDocument:
    #           Version: "2008-10-17"
    #           Statement:
    #             - Effect: "Allow"
    #               Action:
    #                 - "ses:SendEmail"
    #                 - "ses:SendRawEmail"
    #               Resource: "arn:aws:ses:eu-west-1:834819762693:identity/magicmirror.gavin.ie"

    # Creates a user pool
    UserPool:
      Type: "AWS::Cognito::UserPool"
      Properties:
        UserPoolName: ${{self:service}}UserPool
        # AliasAttributes:
        #   - email
        # AutoVerifiedAttributes:
        #   - email

        # EmailConfiguration:
        #   ReplyToEmailAddress: do-not-reply@magicmirror.gavin.ie
        #   SourceArn:
        #     Fn::GetAtt: [SESRole, Arn]
        EmailVerificationSubject: "Magic Mirror verification code"
        EmailVerificationMessage: "Please click the link below to verify your email address. {####} "
        Schema:
          - Name: name
            AttributeDataType: String
            Mutable: true
            Required: true
          # - Name: email
          #   AttributeDataType: String
          #   Mutable: false
          #   Required: true
        DeviceConfiguration:
          DeviceOnlyRememberedOnUserPrompt: true
        Policies:
          PasswordPolicy:
            RequireLowercase: true
            RequireUppercase: true
            RequireSymbols: false
            RequireNumbers: true
            MinimumLength: 8

    # Creates a User Pool Client to be used by the identity pool
    UserPoolClient:
      Type: "AWS::Cognito::UserPoolClient"
      Properties:
        ClientName: ${{self:service}}UserPoolClient
        GenerateSecret: false
        UserPoolId:
          Ref: UserPool

    # Creates a federeated Identity pool
    IdentityPool:
      Type: "AWS::Cognito::IdentityPool"
      Properties:
        IdentityPoolName: ${{self:service}}IdentityPool
        AllowUnauthenticatedIdentities: false
        CognitoIdentityProviders:
          - ClientId:
              Ref: UserPoolClient
            ProviderName:
              'Fn::GetAtt': [ UserPool, ProviderName ]
        # SupportedLoginProviders:
        #   'graph.facebook.com': "xxxxxxxxxx"
        # OpenIdConnectProviderARNs:
        #   - 'arn:aws:iam::xxxxxxxxxxx:oidc-provider/accounts.google.com'

    # # Create a role for unauthorized acces to AWS resources. Very limited access. Only allows users in the previously created Identity Pool
    # CognitoUnAuthorizedRole:
    #   Type: "AWS::IAM::Role"
    #   Properties:
    #     AssumeRolePolicyDocument:
    #       Version: "2012-10-17"
    #       Statement:
    #         - Effect: "Allow"
    #           Principal:
    #             Federated: "cognito-identity.amazonaws.com"
    #           Action:
    #             - "sts:AssumeRoleWithWebIdentity"
    #           Condition:
    #             StringEquals:
    #               "cognito-identity.amazonaws.com:aud":
    #                 Ref: IdentityPool
    #             "ForAnyValue:StringLike":
    #               "cognito-identity.amazonaws.com:amr": unauthenticated
    #     Policies:
    #       - PolicyName: "CognitoUnauthorizedPolicy"
    #         PolicyDocument:
    #           Version: "2012-10-17"
    #           Statement:
    #             - Effect: "Allow"
    #               Action:
    #                 - "mobileanalytics:PutEvents"
    #                 - "cognito-sync:*"
    #               Resource: "*"

    # Create a role for authorized access to AWS resources. Control what your user can access. This example only allows Lambda invokation
    # Only allows users in the previously created Identity Pool
    CognitoAuthorizedRole:
      Type: "AWS::IAM::Role"
      Properties:
        AssumeRolePolicyDocument:
          Version: "2012-10-17"
          Statement:
            - Effect: "Allow"
              Principal:
                Federated: "cognito-identity.amazonaws.com"
              Action:
                - "sts:AssumeRoleWithWebIdentity"
              Condition:
                StringEquals:
                  "cognito-identity.amazonaws.com:aud":
                    Ref: IdentityPool
                "ForAnyValue:StringLike":
                  "cognito-identity.amazonaws.com:amr": authenticated
        Policies:
          - PolicyName: "CognitoAuthorizedPolicy"
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                - Effect: "Allow"
                  Action:
                    - "mobileanalytics:PutEvents"
                    - "cognito-sync:*"
                    - "cognito-identity:*"
                  Resource: "*"
                # - Effect: "Allow"  # TODO temp
                #   Action:
                #     - "rekognition:CompareFaces"
                #     - "rekognition:CreateCollection"
                #     - "rekognition:DeleteCollection"
                #     - "rekognition:DeleteFaces"
                #     - "rekognition:DetectFaces"
                #     - "rekognition:DetectLabels"
                #     - "rekognition:IndexFaces"
                #     - "rekognition:ListCollections"
                #     - "rekognition:ListFaces"
                #     - "rekognition:SearchFaces"
                #     - "rekognition:SearchFacesByImage"
                #   Resource: "*"  # arn:aws:rekognition:region:account-id:collection/collection-id
                - Effect: "Allow"
                  Action:
                    - "dynamodb:GetItem"
                    - "dynamodb:PutItem"
                    - "dynamodb:Query"
                  Resource:
                    Fn::Join:
                      - ""
                      - - "arn:aws:dynamodb:"
                        - Ref: AWS::Region
                        - ":"
                        - Ref: AWS::AccountId
                        - ":table/"
                        - Ref: UsersTable
                  Condition:
                    "ForAllValues:StringEquals":
                      "dynamodb:LeadingKeys":
                        "${cognito-identity.amazonaws.com:sub}"
                # - Effect: "Allow"
                #   Action:
                #     - "lambda:InvokeFunction"
                #   Resource: "*"

    # Assigns the roles to the Identity Pool
    IdentityPoolRoleMapping:
      Type: "AWS::Cognito::IdentityPoolRoleAttachment"
      Properties:
        IdentityPoolId:
          Ref: IdentityPool
        Roles:
          authenticated:
              'Fn::GetAtt': [ CognitoAuthorizedRole, Arn ]
          # unauthenticated:
          #     'Fn::GetAtt': [ CognitoUnAuthorizedRole, Arn ]

    UsersTable:
      Type: AWS::DynamoDB::Table
      DeletionPolicy: Retain
      Properties:
        TableName: ${{self:custom.variables.dynamodb.usersTableName}}
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
        KeySchema:
          - AttributeName: userId
            KeyType: HASH
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1

    DeviceGroupTable:
      Type: AWS::DynamoDB::Table
      DeletionPolicy: Retain
      Properties:
        TableName: ${{self:custom.variables.dynamodb.deviceGroupTableName}}
        AttributeDefinitions:
          - AttributeName: groupId
            AttributeType: S
          # groupName
        KeySchema:
          - AttributeName: groupId
            KeyType: HASH
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1

    DeviceGroupUsersTable:
      Type: AWS::DynamoDB::Table
      DeletionPolicy: Retain
      Properties:
        TableName: ${{self:custom.variables.dynamodb.deviceGroupUsersTableName}}
        AttributeDefinitions:
          - AttributeName: groupId
            AttributeType: S
          - AttributeName: userId
            AttributeType: S
          # groupOwner
        KeySchema:
          - AttributeName: groupId
            KeyType: HASH
          - AttributeName: userId
            KeyType: RANGE
        GlobalSecondaryIndexes:
        - IndexName: useridGSI
          Projection:
            ProjectionType: ALL
          KeySchema:
            - AttributeName: userId
              KeyType: "HASH"
          ProvisionedThroughput:
            ReadCapacityUnits: 1
            WriteCapacityUnits: 1
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1

    DeviceGroupUserFacesTable:
      Type: AWS::DynamoDB::Table
      DeletionPolicy: Retain
      Properties:
        TableName: ${{self:custom.variables.dynamodb.deviceGroupUserFacesTableName}}
        AttributeDefinitions:
          - AttributeName: groupId
            AttributeType: S
          - AttributeName: faceId
            AttributeType: S
          - AttributeName: userId
            AttributeType: S
        KeySchema:
          - AttributeName: groupId
            KeyType: HASH
          - AttributeName: faceId
            KeyType: RANGE
        GlobalSecondaryIndexes:
        - IndexName: groupIdUserIdGSI
          Projection:
            ProjectionType: ALL
          KeySchema:
            - AttributeName: groupId
              KeyType: HASH
            - AttributeName: userId
              KeyType: RANGE
          ProvisionedThroughput:
            ReadCapacityUnits: 1
            WriteCapacityUnits: 1
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1

  Outputs:
    # UserPoolArn:
    #   Value:
    #     Fn::GetAtt: [ UserPool, Arn ]
    #   Export:
    #     Name: "UserPool::Arn"
    UserPoolId:
      Value:
        Ref: UserPool
      Export:
        Name: "UserPool::Id"
    UserPoolClientId:
      Value:
        Ref: UserPoolClient
      Export:
        Name: "UserPoolClient::Id"
    IdentityPoolId:
      Value:
        Ref: IdentityPool
      Export:
        Name: "IdentityPool::Id"


# resources:
#   Resources:
#     uploadBucket:
#       Type: AWS::S3::Bucket
#       Properties:
#         BucketName: ${{self:service}}-${{self:provider.stage}}-uploads
#
#     usersTable:
#       Type: AWS::DynamoDB::Table
#       Properties:
#         TableName: ${{self:service}}-${{self:provider.stage}}-users
#         AttributeDefinitions:
#           - AttributeName: userId
#             AttributeType: S
#         KeySchema:
#           - AttributeName: userId
#             KeyType: HASH
#         ProvisionedThroughput:
#           ReadCapacityUnits: 1
#           WriteCapacityUnits: 1
